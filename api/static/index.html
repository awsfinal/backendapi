<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¸ Historical Building Recognition - Camera Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 10px;
        }
        
        .camera-section {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border: none;
        }
        
        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .camera-preview {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #cameraVideo {
            width: 100%;
            height: auto;
            max-height: 400px;
        }
        
        #capturedImage {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
        }
        
        .camera-placeholder {
            color: white;
            text-align: center;
            padding: 40px;
        }
        
        .btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 5px 0;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn.secondary:hover {
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }
        
        .gps-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .gps-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .metadata-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .metadata-info h4 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }
        
        .api-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .api-endpoint {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .api-endpoint h3 {
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .method.get { background: #28a745; color: white; }
        .method.post { background: #007bff; color: white; }
        
        @media (max-width: 768px) {
            .camera-controls {
                grid-template-columns: 1fr;
            }
            
            .api-test {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¸ Historical Building Recognition</h1>
            <p>ì¹´ë©”ë¼ë¡œ ê±´ë¬¼ì„ ì´¬ì˜í•˜ì—¬ ì—­ì‚¬ì  ì •ë³´ë¥¼ ì•Œì•„ë³´ì„¸ìš”</p>
        </div>
        
        <div class="content">
            <!-- API ìƒíƒœ í™•ì¸ ì„¹ì…˜ -->
            <div class="section">
                <h2>ğŸ” API ìƒíƒœ í™•ì¸</h2>
                <div class="api-test">
                    <div class="api-endpoint">
                        <h3>ì„œë²„ ìƒíƒœ</h3>
                        <span class="method get">GET</span>
                        <code>/</code>
                        <button class="btn secondary" onclick="checkServerStatus()" style="width: auto; margin-top: 10px;">í™•ì¸</button>
                    </div>
                    <div class="api-endpoint">
                        <h3>í—¬ìŠ¤ ì²´í¬</h3>
                        <span class="method get">GET</span>
                        <code>/health</code>
                        <button class="btn secondary" onclick="checkHealth()" style="width: auto; margin-top: 10px;">í™•ì¸</button>
                    </div>
                </div>
                <div id="statusResult" class="result"></div>
            </div>
            
            <!-- ì¹´ë©”ë¼ ì´¬ì˜ ì„¹ì…˜ -->
            <div class="section camera-section">
                <h2>ğŸ“· ì¹´ë©”ë¼ë¡œ ê±´ë¬¼ ì´¬ì˜í•˜ê¸°</h2>
                
                <div class="camera-controls">
                    <button class="btn" onclick="startCamera()" id="startCameraBtn">ğŸ“¹ ì¹´ë©”ë¼ ì‹œì‘</button>
                    <button class="btn" onclick="capturePhoto()" id="captureBtn" disabled>ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</button>
                </div>
                
                <div class="camera-preview" id="cameraPreview">
                    <video id="cameraVideo" autoplay playsinline style="display: none;"></video>
                    <img id="capturedImage" style="display: none;" alt="ì´¬ì˜ëœ ì‚¬ì§„">
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        <h3>ğŸ“± ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ì„¸ìš”</h3>
                        <p>ì‹¤ì œ ê±´ë¬¼ì„ ì´¬ì˜í•˜ì—¬ ì—­ì‚¬ì  ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
                
                <div class="gps-info">
                    <div class="gps-status">
                        <span class="gps-icon" id="gpsIcon">ğŸ“</span>
                        <span id="gpsStatus">GPS ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>
                    </div>
                    <div id="gpsCoords" style="font-size: 14px; color: #666;"></div>
                </div>
                
                <div class="camera-controls">
                    <button class="btn" onclick="analyzePhoto()" id="analyzeBtn" disabled>ğŸ” ê±´ë¬¼ ë¶„ì„ ì‹œì‘</button>
                    <button class="btn secondary" onclick="resetCamera()" id="resetBtn">ğŸ”„ ë‹¤ì‹œ ì´¬ì˜</button>
                </div>
                
                <div class="loading" id="cameraLoading">
                    <div class="spinner"></div>
                    <p>ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ê±´ë¬¼ ì •ë³´ë¥¼ ì°¾ëŠ” ì¤‘...</p>
                </div>
                
                <div id="cameraResult" class="result"></div>
                
                <div id="metadataInfo" class="metadata-info" style="display: none;">
                    <h4>ğŸ“Š ì‚¬ì§„ ë©”íƒ€ë°ì´í„°</h4>
                    <div id="metadataContent"></div>
                </div>
            </div>
            
            <!-- ì¥ì†Œ ê²€ìƒ‰ ì„¹ì…˜ -->
            <div class="section">
                <h2>ğŸ—ºï¸ ì¥ì†Œ ê²€ìƒ‰ (ì¹´ì¹´ì˜¤ë§µ ì—°ë™)</h2>
                <div class="form-group">
                    <label for="searchKeyword">ê²€ìƒ‰ í‚¤ì›Œë“œ</label>
                    <input type="text" id="searchKeyword" placeholder="ì˜ˆ: ê²½ë³µê¶, ë‚¨ì‚°íƒ€ì›Œ, ë•ìˆ˜ê¶">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="searchLat">ìœ„ë„ (ì„ íƒì‚¬í•­)</label>
                        <input type="number" id="searchLat" step="any" placeholder="37.5759">
                    </div>
                    <div class="form-group">
                        <label for="searchLng">ê²½ë„ (ì„ íƒì‚¬í•­)</label>
                        <input type="number" id="searchLng" step="any" placeholder="126.9769">
                    </div>
                </div>
                
                <button class="btn secondary" onclick="searchPlace()">ğŸ” ì¥ì†Œ ê²€ìƒ‰</button>
                
                <div class="loading" id="searchLoading">
                    <div class="spinner"></div>
                    <p>ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘...</p>
                </div>
                
                <div id="searchResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        // ì¹´ë©”ë¼ ë° GPS ê´€ë ¨ ë³€ìˆ˜
        let cameraStream = null;
        let capturedImageBlob = null;
        let currentGPS = null;
        
        // DOM ìš”ì†Œë“¤
        const cameraVideo = document.getElementById('cameraVideo');
        const capturedImage = document.getElementById('capturedImage');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        // GPS ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'));
                    return;
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                };
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        resolve(coords);
                    },
                    (error) => {
                        let message = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message = 'ìœ„ì¹˜ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                                break;
                            case error.TIMEOUT:
                                message = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ì´ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                break;
                        }
                        reject(new Error(message));
                    },
                    options
                );
            });
        }
        
        // GPS ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateGPSStatus() {
            const gpsIcon = document.getElementById('gpsIcon');
            const gpsStatus = document.getElementById('gpsStatus');
            const gpsCoords = document.getElementById('gpsCoords');
            
            try {
                gpsStatus.textContent = 'GPS ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                gpsIcon.textContent = 'ğŸ”„';
                
                const location = await getCurrentLocation();
                currentGPS = location;
                
                gpsIcon.textContent = 'âœ…';
                gpsStatus.textContent = 'ìœ„ì¹˜ ì •ë³´ íšë“ ì™„ë£Œ';
                gpsCoords.innerHTML = `
                    <strong>ìœ„ë„:</strong> ${location.latitude.toFixed(6)}<br>
                    <strong>ê²½ë„:</strong> ${location.longitude.toFixed(6)}<br>
                    <strong>ì •í™•ë„:</strong> Â±${location.accuracy.toFixed(0)}m
                `;
                
            } catch (error) {
                gpsIcon.textContent = 'âŒ';
                gpsStatus.textContent = error.message;
                gpsCoords.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                currentGPS = null;
            }
        }
        
        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¼ ì‹œì‘
                const constraints = {
                    video: {
                        facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // ë¹„ë””ì˜¤ ìš”ì†Œì— ìŠ¤íŠ¸ë¦¼ ì—°ê²°
                cameraVideo.srcObject = cameraStream;
                cameraVideo.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                capturedImage.style.display = 'none';
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                startCameraBtn.disabled = true;
                startCameraBtn.textContent = 'ğŸ“¹ ì¹´ë©”ë¼ ì‹¤í–‰ ì¤‘';
                captureBtn.disabled = false;
                
                showResult('cameraResult', 'info', 'ğŸ“¹ ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ê±´ë¬¼ì„ í™”ë©´ì— ë§ì¶° ì´¬ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', error);
                let message = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                
                if (error.name === 'NotAllowedError') {
                    message = 'ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                } else if (error.name === 'NotFoundError') {
                    message = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                } else if (error.name === 'NotSupportedError') {
                    message = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                }
                
                showResult('cameraResult', 'error', `âŒ ${message}`);
            }
        }
        
        // ì‚¬ì§„ ì´¬ì˜
        function capturePhoto() {
            if (!cameraStream) {
                showResult('cameraResult', 'error', 'âŒ ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // Canvasë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë””ì˜¤ì—ì„œ ì´ë¯¸ì§€ ìº¡ì²˜
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            
            context.drawImage(cameraVideo, 0, 0);
            
            // ìº¡ì²˜ëœ ì´ë¯¸ì§€ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            canvas.toBlob((blob) => {
                capturedImageBlob = blob;
                
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const imageUrl = URL.createObjectURL(blob);
                capturedImage.src = imageUrl;
                capturedImage.style.display = 'block';
                cameraVideo.style.display = 'none';
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                captureBtn.disabled = true;
                captureBtn.textContent = 'ğŸ“¸ ì´¬ì˜ ì™„ë£Œ';
                analyzeBtn.disabled = false;
                
                showResult('cameraResult', 'success', 'ğŸ“¸ ì‚¬ì§„ì´ ì´¬ì˜ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ê±´ë¬¼ ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                
            }, 'image/jpeg', 0.9);
        }
        
        // ì¹´ë©”ë¼ ë¦¬ì…‹
        function resetCamera() {
            // ìŠ¤íŠ¸ë¦¼ ì •ì§€
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // UI ë¦¬ì…‹
            cameraVideo.style.display = 'none';
            capturedImage.style.display = 'none';
            cameraPlaceholder.style.display = 'block';
            
            // ë²„íŠ¼ ìƒíƒœ ë¦¬ì…‹
            startCameraBtn.disabled = false;
            startCameraBtn.textContent = 'ğŸ“¹ ì¹´ë©”ë¼ ì‹œì‘';
            captureBtn.disabled = true;
            captureBtn.textContent = 'ğŸ“¸ ì‚¬ì§„ ì´¬ì˜';
            analyzeBtn.disabled = true;
            
            // ìº¡ì²˜ëœ ì´ë¯¸ì§€ ì´ˆê¸°í™”
            capturedImageBlob = null;
            
            // ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('cameraResult').style.display = 'none';
            document.getElementById('metadataInfo').style.display = 'none';
        }
        
        // ì‚¬ì§„ ë¶„ì„
        async function analyzePhoto() {
            if (!capturedImageBlob) {
                showResult('cameraResult', 'error', 'âŒ ì´¬ì˜ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', capturedImageBlob, 'captured_photo.jpg');
            
            // GPS ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            if (currentGPS) {
                formData.append('device_latitude', currentGPS.latitude);
                formData.append('device_longitude', currentGPS.longitude);
            }
            
            showLoading('cameraLoading', true);
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ğŸ” ë¶„ì„ ì¤‘...';
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/capture-photo`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('cameraResult', 'success', `
                        <h3>ğŸ‰ ì‚¬ì§„ ë¶„ì„ ì‹œì‘!</h3>
                        <p><strong>ìš”ì²­ ID:</strong> ${data.request_id}</p>
                        <p><strong>ìƒíƒœ:</strong> ${data.status}</p>
                        <p><strong>GPS ì†ŒìŠ¤:</strong> ${data.gps_info?.source || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                        <p><strong>ì¸ì‹ëœ ì¥ì†Œ:</strong> ${data.place_info?.place_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                        <p><strong>ì£¼ì†Œ:</strong> ${data.place_info?.address || 'ì£¼ì†Œ ì—†ìŒ'}</p>
                        <p><strong>ì²˜ë¦¬ ì‹œê°„:</strong> ${data.processing_time?.toFixed(2)}ì´ˆ</p>
                        <p><strong>ì˜ˆìƒ ì™„ë£Œ:</strong> ${data.estimated_completion}</p>
                    `);
                    
                    // ë©”íƒ€ë°ì´í„° ì •ë³´ í‘œì‹œ
                    if (data.camera_info || data.exif_info) {
                        showMetadata(data.camera_info, data.exif_info);
                    }
                    
                    // ë¶„ì„ ìƒíƒœ ì£¼ê¸°ì  í™•ì¸ ì‹œì‘
                    if (data.request_id) {
                        startStatusPolling(data.request_id);
                    }
                    
                } else {
                    showResult('cameraResult', 'error', `âŒ ë¶„ì„ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                showResult('cameraResult', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                showLoading('cameraLoading', false);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ğŸ” ê±´ë¬¼ ë¶„ì„ ì‹œì‘';
            }
        }
        
        // ë©”íƒ€ë°ì´í„° ì •ë³´ í‘œì‹œ
        function showMetadata(cameraInfo, exifInfo) {
            const metadataDiv = document.getElementById('metadataInfo');
            const contentDiv = document.getElementById('metadataContent');
            
            let html = '';
            
            if (exifInfo) {
                html += `
                    <p><strong>EXIF ë°ì´í„°:</strong> ${exifInfo.has_exif ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}</p>
                    <p><strong>GPS ì •ë³´:</strong> ${exifInfo.has_gps ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}</p>
                `;
            }
            
            if (cameraInfo && Object.keys(cameraInfo).length > 0) {
                html += '<h5>ğŸ“± ì¹´ë©”ë¼ ì •ë³´:</h5>';
                if (cameraInfo.make) html += `<p><strong>ì œì¡°ì‚¬:</strong> ${cameraInfo.make}</p>`;
                if (cameraInfo.model) html += `<p><strong>ëª¨ë¸:</strong> ${cameraInfo.model}</p>`;
                if (cameraInfo.datetime) html += `<p><strong>ì´¬ì˜ ì‹œê°„:</strong> ${cameraInfo.datetime}</p>`;
                if (cameraInfo.width && cameraInfo.height) {
                    html += `<p><strong>í•´ìƒë„:</strong> ${cameraInfo.width} Ã— ${cameraInfo.height}</p>`;
                }
            }
            
            if (html) {
                contentDiv.innerHTML = html;
                metadataDiv.style.display = 'block';
            }
        }
        
        // ë¶„ì„ ìƒíƒœ ì£¼ê¸°ì  í™•ì¸
        function startStatusPolling(requestId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/v1/analysis-status/${requestId}`);
                    const data = await response.json();
                    
                    if (data.status === 'COMPLETED') {
                        clearInterval(pollInterval);
                        showFinalResult(data.result);
                    } else if (data.status === 'FAILED') {
                        clearInterval(pollInterval);
                        showResult('cameraResult', 'error', `âŒ ë¶„ì„ ì‹¤íŒ¨: ${data.message}`);
                    } else {
                        // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                        const progress = data.progress || 0;
                        showResult('cameraResult', 'info', `
                            <h3>ğŸ”„ ë¶„ì„ ì§„í–‰ ì¤‘... (${progress}%)</h3>
                            <p>${data.message}</p>
                        `);
                    }
                } catch (error) {
                    console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                }
            }, 3000); // 3ì´ˆë§ˆë‹¤ í™•ì¸
            
            // 5ë¶„ í›„ ìë™ ì¤‘ë‹¨
            setTimeout(() => {
                clearInterval(pollInterval);
            }, 300000);
        }
        
        // ì„œë²„ ìƒíƒœ í™•ì¸
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                showResult('statusResult', 'success', `
                    <h3>âœ… ì„œë²„ ìƒíƒœ: ì •ìƒ</h3>
                    <p><strong>í”„ë¡œì íŠ¸:</strong> ${data.message}</p>
                    <p><strong>ë²„ì „:</strong> ${data.version}</p>
                    <p><strong>ìƒíƒœ:</strong> ${data.status}</p>
                    <p><strong>ì‹œê°„:</strong> ${data.timestamp}</p>
                `);
            } catch (error) {
                showResult('statusResult', 'error', `âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // í—¬ìŠ¤ ì²´í¬
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                let servicesHtml = '';
                for (const [service, status] of Object.entries(data.services)) {
                    const icon = status === 'connected' ? 'âœ…' : 'âš ï¸';
                    servicesHtml += `<p><strong>${service}:</strong> ${icon} ${status}</p>`;
                }
                
                showResult('statusResult', 'success', `
                    <h3>ğŸ¥ í—¬ìŠ¤ ì²´í¬ ê²°ê³¼</h3>
                    <p><strong>ì „ì²´ ìƒíƒœ:</strong> ${data.status}</p>
                    <p><strong>ì‹œê°„:</strong> ${data.timestamp}</p>
                    <h4>ì„œë¹„ìŠ¤ ìƒíƒœ:</h4>
                    ${servicesHtml}
                `);
            } catch (error) {
                showResult('statusResult', 'error', `âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì¥ì†Œ ê²€ìƒ‰
        async function searchPlace() {
            const keyword = document.getElementById('searchKeyword').value;
            if (!keyword) {
                showResult('searchResult', 'error', 'âŒ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const lat = document.getElementById('searchLat').value;
            const lng = document.getElementById('searchLng').value;
            
            let url = `${API_BASE}/api/v1/search-place?keyword=${encodeURIComponent(keyword)}`;
            if (lat && lng) {
                url += `&latitude=${lat}&longitude=${lng}`;
            }
            
            showLoading('searchLoading', true);
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('searchResult', 'success', `
                        <h3>ğŸ¯ ê²€ìƒ‰ ê²°ê³¼</h3>
                        <p><strong>ì¥ì†Œëª…:</strong> ${data.place_name}</p>
                        <p><strong>ì£¼ì†Œ:</strong> ${data.address}</p>
                        <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${data.category || 'ì—†ìŒ'}</p>
                        ${data.distance ? `<p><strong>ê±°ë¦¬:</strong> ${data.distance}m</p>` : ''}
                    `);
                } else {
                    showResult('searchResult', 'error', `âŒ ê²€ìƒ‰ ì‹¤íŒ¨: ${data.message || 'ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}`);
                }
            } catch (error) {
                showResult('searchResult', 'error', `âŒ ê²€ìƒ‰ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                showLoading('searchLoading', false);
            }
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showResult(elementId, type, content) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = content;
            element.style.display = 'block';
        }
        
        function showLoading(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'block' : 'none';
        }
        
        // ìƒ˜í”Œ GPS ì¢Œí‘œ ì„¤ì •
        function setSampleLocation(name, lat, lng) {
            document.getElementById('searchLat').value = lat;
            document.getElementById('searchLng').value = lng;
            showResult('searchResult', 'info', `ğŸ“ ${name} ì¢Œí‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            // ì„œë²„ ìƒíƒœ í™•ì¸
            checkServerStatus();
            
            // GPS ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            updateGPSStatus();
            
            // ë¸Œë¼ìš°ì € ì§€ì› í™•ì¸
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showResult('cameraResult', 'error', 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                startCameraBtn.disabled = true;
            }
            
            if (!navigator.geolocation) {
                document.getElementById('gpsStatus').textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                document.getElementById('gpsIcon').textContent = 'âŒ';
            }
        });
    </script>
    
    <!-- ìƒ˜í”Œ ìœ„ì¹˜ ë²„íŠ¼ë“¤ -->
    <div style="position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 1000;">
        <h4 style="margin-bottom: 10px;">ğŸ“ ìœ ëª… ê±´ë¬¼ ìœ„ì¹˜</h4>
        <button onclick="setSampleLocation('ê²½ë³µê¶', 37.5759, 126.9769)" style="display: block; margin: 5px 0; padding: 5px 10px; border: none; background: #ff6b6b; color: white; border-radius: 5px; cursor: pointer;">ğŸ›ï¸ ê²½ë³µê¶</button>
        <button onclick="setSampleLocation('ë‚¨ì‚°íƒ€ì›Œ', 37.5512, 126.9882)" style="display: block; margin: 5px 0; padding: 5px 10px; border: none; background: #ff6b6b; color: white; border-radius: 5px; cursor: pointer;">ğŸ—¼ ë‚¨ì‚°íƒ€ì›Œ</button>
        <button onclick="setSampleLocation('ë•ìˆ˜ê¶', 37.5658, 126.9751)" style="display: block; margin: 5px 0; padding: 5px 10px; border: none; background: #ff6b6b; color: white; border-radius: 5px; cursor: pointer;">ğŸ° ë•ìˆ˜ê¶</button>
        <button onclick="setSampleLocation('ì°½ë•ê¶', 37.5794, 126.9910)" style="display: block; margin: 5px 0; padding: 5px 10px; border: none; background: #ff6b6b; color: white; border-radius: 5px; cursor: pointer;">ğŸŒ¸ ì°½ë•ê¶</button>
    </div>
</body>
</html>
        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                showResult('statusResult', 'success', `
                    <h3>âœ… ì„œë²„ ìƒíƒœ: ì •ìƒ</h3>
                    <p><strong>í”„ë¡œì íŠ¸:</strong> ${data.message}</p>
                    <p><strong>ë²„ì „:</strong> ${data.version}</p>
                    <p><strong>ìƒíƒœ:</strong> ${data.status}</p>
                    <p><strong>ì‹œê°„:</strong> ${data.timestamp}</p>
                `);
            } catch (error) {
                showResult('statusResult', 'error', `âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // í—¬ìŠ¤ ì²´í¬
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                let servicesHtml = '';
                for (const [service, status] of Object.entries(data.services)) {
                    const icon = status === 'connected' ? 'âœ…' : 'âš ï¸';
                    servicesHtml += `<p><strong>${service}:</strong> ${icon} ${status}</p>`;
                }
                
                showResult('statusResult', 'success', `
                    <h3>ğŸ¥ í—¬ìŠ¤ ì²´í¬ ê²°ê³¼</h3>
                    <p><strong>ì „ì²´ ìƒíƒœ:</strong> ${data.status}</p>
                    <p><strong>ì‹œê°„:</strong> ${data.timestamp}</p>
                    <h4>ì„œë¹„ìŠ¤ ìƒíƒœ:</h4>
                    ${servicesHtml}
                `);
            } catch (error) {
                showResult('statusResult', 'error', `âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì‚¬ì§„ ì—…ë¡œë“œ
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedFile) {
                showResult('uploadResult', 'error', 'âŒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            
            if (!latitude || !longitude) {
                showResult('uploadResult', 'error', 'âŒ GPS ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('latitude', latitude);
            formData.append('longitude', longitude);
            
            showLoading('uploadLoading', true);
            document.getElementById('uploadBtn').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/upload-photo`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('uploadResult', 'success', `
                        <h3>ğŸ‰ ì—…ë¡œë“œ ì„±ê³µ!</h3>
                        <p><strong>ìš”ì²­ ID:</strong> ${data.request_id}</p>
                        <p><strong>ìƒíƒœ:</strong> ${data.status}</p>
                        <p><strong>ì¥ì†Œëª…:</strong> ${data.place_info?.place_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                        <p><strong>ì£¼ì†Œ:</strong> ${data.place_info?.address || 'ì£¼ì†Œ ì—†ìŒ'}</p>
                        <p><strong>ì²˜ë¦¬ ì‹œê°„:</strong> ${data.processing_time?.toFixed(2)}ì´ˆ</p>
                        <p><strong>ì˜ˆìƒ ì™„ë£Œ:</strong> ${data.estimated_completion}</p>
                    `);
                } else {
                    showResult('uploadResult', 'error', `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                showResult('uploadResult', 'error', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                showLoading('uploadLoading', false);
                document.getElementById('uploadBtn').disabled = false;
            }
        });
        
        // ì¥ì†Œ ê²€ìƒ‰
        async function searchPlace() {
            const keyword = document.getElementById('searchKeyword').value;
            if (!keyword) {
                showResult('searchResult', 'error', 'âŒ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const lat = document.getElementById('searchLat').value;
            const lng = document.getElementById('searchLng').value;
            
            let url = `${API_BASE}/api/v1/search-place?keyword=${encodeURIComponent(keyword)}`;
            if (lat && lng) {
                url += `&latitude=${lat}&longitude=${lng}`;
            }
            
            showLoading('searchLoading', true);
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('searchResult', 'success', `
                        <h3>ğŸ¯ ê²€ìƒ‰ ê²°ê³¼</h3>
                        <p><strong>ì¥ì†Œëª…:</strong> ${data.place_name}</p>
                        <p><strong>ì£¼ì†Œ:</strong> ${data.address}</p>
                        <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${data.category || 'ì—†ìŒ'}</p>
                    `);
                } else {
                    showResult('searchResult', 'error', `âŒ ê²€ìƒ‰ ì‹¤íŒ¨: ${data.message || 'ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}`);
                }
            } catch (error) {
                showResult('searchResult', 'error', `âŒ ê²€ìƒ‰ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                showLoading('searchLoading', false);
            }
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showResult(elementId, type, content) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = content;
            element.style.display = 'block';
        }
        
        function showLoading(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'block' : 'none';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ ìƒíƒœ í™•ì¸
        window.addEventListener('load', () => {
            checkServerStatus();
        });
        
        // ìƒ˜í”Œ GPS ì¢Œí‘œ ë²„íŠ¼ë“¤
        function setSampleLocation(name, lat, lng) {
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            showResult('uploadResult', 'info', `ğŸ“ ${name} ì¢Œí‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
    </script>
    
    <!-- ìƒ˜í”Œ ìœ„ì¹˜ ë²„íŠ¼ë“¤ -->
    <div style="position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <h4 style="margin-bottom: 10px;">ğŸ“ ìƒ˜í”Œ ìœ„ì¹˜</h4>
        <button onclick="setSampleLocation('ê²½ë³µê¶', 37.5759, 126.9769)" style="display: block; margin: 5px 0; padding: 5px 10px; border: none; background: #4facfe; color: white; border-radius: 5px; cursor: pointer;">ê²½ë³µê¶</button>
        <button onclick="setSampleLocation('ë‚¨ì‚°íƒ€ì›Œ', 37.5512, 126.9882)" style="display: block; margin: 5px 0; padding: 5px 10px; border: none; background: #4facfe; color: white; border-radius: 5px; cursor: pointer;">ë‚¨ì‚°íƒ€ì›Œ</button>
        <button onclick="setSampleLocation('ì²­ì™€ëŒ€', 37.5867, 126.9748)" style="display: block; margin: 5px 0; padding: 5px 10px; border: none; background: #4facfe; color: white; border-radius: 5px; cursor: pointer;">ì²­ì™€ëŒ€</button>
    </div>
</body>
</html>
